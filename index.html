<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AIRMM Assessment v0.2</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f1220; --panel:#14182b; --muted:#99a3b3; --accent:#7aa2ff; --accent-2:#00d3b7;
      --danger:#ff6b6b; --ok:#22c55e; --warn:#f59e0b; --card:#161a31; --chip:#1b2040; --border:rgba(255,255,255,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
      background:radial-gradient(1200px 600px at 80% -100px, #1b2143 0%, transparent 60%) , var(--bg);
      color:#e8eefc; letter-spacing:.2px;
    }
    header{
      display:flex; align-items:center; justify-content:space-between; gap:16px;
      padding:16px 20px; border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,0));
      position:sticky; top:0; z-index:10; backdrop-filter:saturate(120%) blur(6px);
    }
    .brand{display:flex; align-items:center; gap:12px}
    .brand .title h1{margin:0; font-size:18px; font-weight:800}
    .brand .title small{color:var(--muted)}
    .actions{display:flex; align-items:center; gap:8px}
    .btn{background:#1b2040; border:1px solid var(--border); color:#e8eefc; padding:9px 14px; border-radius:12px; cursor:pointer; transition:.2s; font-weight:600;}
    .btn:hover{transform:translateY(-1px); box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .btn.primary{background:linear-gradient(135deg, var(--accent), var(--accent-2)); color:#0c1024; border-color:transparent}

    .app{display:grid; grid-template-columns: 280px 1fr; gap:16px; padding:16px; height:calc(100% - 74px)}
    aside{background:var(--panel); border:1px solid var(--border); border-radius:18px; padding:16px; overflow:auto}
    main{display:grid; grid-template-rows:auto 1fr; gap:16px; min-height:0}

    .tabs{display:flex; align-items:center; gap:8px}
    .tab{padding:10px 14px; background:#141a33; border:1px solid var(--border); border-radius:12px; cursor:pointer; color:var(--muted); font-weight:600}
    .tab.active{background:linear-gradient(135deg,#1b2248,#16213a); color:#e8eefc}

    .panels{background:var(--panel); border:1px solid var(--border); border-radius:18px; padding:0; overflow:hidden;}
    .panel{display:none; height:100%; overflow:auto}
    .panel.active{display:block}

    .domain-list{display:flex; flex-direction:column; gap:10px}
    .domain{padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:var(--card); cursor:pointer; display:flex; align-items:center; justify-content:space-between}
    .domain.active{outline:2px solid rgba(122,162,255,.45)}
    .domain small{color:var(--muted)}

    .search{position:relative; margin:8px 0 12px}
    .search input{width:100%; padding:10px 12px 10px 36px; border-radius:12px; border:1px solid var(--border); background:#0e1328; color:#e8eefc}
    .search svg{position:absolute; left:10px; top:50%; transform:translateY(-50%); width:18px; height:18px; fill:var(--muted)}

    .controls-wrap{padding:18px}
    .control-card{border:1px solid var(--border); border-radius:16px; background:linear-gradient(180deg,#12162a,#0f1428); padding:16px; margin-bottom:12px}
    .control-card h3{margin:0 0 6px; font-size:16px}
    .control-card .desc{color:var(--muted); margin-bottom:10px}
    .level-grid{display:grid; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); gap:10px}
    .level{border:1px dashed var(--border); border-radius:12px; padding:10px; background: #0b1022}
    .level h4{margin:0 0 6px; font-size:13px; color:#c2cff9}
    .sub-question{display:grid; gap:6px; padding:8px; border-radius:10px; background:#0c1227; border:1px solid rgba(255,255,255,.03)}
    .sub-question .sq-title{font-size:13px; color:#cbd5ff}
    .answers{display:flex; flex-wrap:wrap; gap:6px}
    .chip{background:var(--chip); border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:12px; cursor:pointer; color:#c8d2ff}
    .chip[data-value="yes"]{background:rgba(34,197,94,.15)}
    .chip[data-value="partial"]{background:rgba(245,158,11,.15)}
    .chip[data-value="no"]{background:rgba(255,107,107,.12)}
    .chip[data-value="na"]{background:rgba(153,163,179,.12)}
    .chip.active{outline:2px solid rgba(122,162,255,.45)}

    .meter{height:10px; background:#0b1022; border:1px solid var(--border); border-radius:999px; overflow:hidden}
    .meter > i{display:block; height:100%; width:0%; background:linear-gradient(90deg, var(--accent), var(--accent-2))}

    .grid{display:grid; grid-template-columns: repeat(12,1fr); gap:12px}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:18px; padding:16px}

    .kpis{display:grid; grid-template-columns: repeat(auto-fit,minmax(160px,1fr)); gap:12px}
    .kpi{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:14px}
    .kpi h5{margin:0; color:#c2cff9}
    .kpi .num{font-size:24px; font-weight:800}
    .muted{color:var(--muted)}

    @media print{
      header, aside, .tabs, .actions{display:none!important}
      .app{grid-template-columns:1fr; gap:0; padding:0}
      .panel.active{display:block}
      .card, .controls-wrap{break-inside:avoid}
      body{background:#fff; color:#000}
    }
  </style>
</head>
<body>
  <header>
    <div class="brand" aria-label="AIRMM">
      <div class="title">
        <h1>AIRMM Assessment</h1>
        <small>v0.2 • Interactive questionnaire & dashboard</small>
      </div>
    </div>
    <div class="actions">
      <!-- Save JSON only (no PDF, no history) -->
      <button class="btn primary" id="btnExportJSON" title="Save current responses as JSON">Save JSON</button>
    </div>
  </header>

  <div class="app">
    <aside>
      <div class="search">
        <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
        <input id="searchInput" placeholder="Search controls or text…" />
      </div>
      <div class="domain-list" id="domainList" aria-live="polite"></div>
    </aside>

    <main>
      <div class="tabs">
        <button class="tab active" data-target="#panel-questions">Questionnaire</button>
        <button class="tab" data-target="#panel-dashboard">Dashboard</button>
      </div>

      <section class="panels">
        <div class="panel active" id="panel-questions">
          <div class="controls-wrap" id="controlsWrap"></div>
        </div>

        <!-- Compact dashboard with inline SVG (non-expanding) -->
        <div class="panel" id="panel-dashboard">
          <div class="grid" style="padding:16px">
            <div class="card" style="grid-column: span 12">
              <div class="kpis" id="kpiRow"></div>
            </div>

            <!-- Stacked distribution bar -->
            <div class="card" style="grid-column: span 6; min-height:160px">
              <h3 style="margin:4px 0 12px">Answers Distribution</h3>
              <div id="distBar" style="width:100%; border:1px solid var(--border); border-radius:10px; overflow:hidden; height:22px; display:flex"></div>
              <div id="distLegend" style="display:flex; gap:12px; margin-top:10px; font-size:12px" class="muted"></div>
            </div>

            <!-- Domain scores (inline SVG bar chart) -->
            <div class="card" style="grid-column: span 6; min-height:220px">
              <h3 style="margin:4px 0 12px">Domain Scores (click to drill down)</h3>
              <div id="domainChartBox" style="width:100%; height:180px"></div>
            </div>

            <!-- Clickable Heatmap -->
            <div class="card" style="grid-column: span 12; min-height:160px">
              <h3 style="margin:4px 0 12px">Heatmap (Yes / Partial / No)</h3>
              <div id="heatmap" class="heat" style="display:grid; grid-template-columns:repeat(6,1fr); gap:6px"></div>
            </div>

            <!-- Drill-down details -->
            <div class="card" style="grid-column: span 12">
              <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap">
                <h3 id="detailTitle" style="margin:4px 0 12px">Details</h3>
                <div style="display:flex; gap:8px">
                  <button class="btn" id="btnDetailQuestions">Open Questionnaire</button>
                  <button class="btn" id="btnDetailReset">Reset Focus</button>
                </div>
              </div>
              <div id="levelSummary" class="kpis"></div>
              <div style="overflow:auto; margin-top:10px">
                <table id="detailTable" style="width:100%; border-collapse:collapse">
                  <thead>
                    <tr>
                      <th style="text-align:left; padding:8px; border-bottom:1px solid var(--border)">Category</th>
                      <th style="text-align:right; padding:8px; border-bottom:1px solid var(--border)">Yes</th>
                      <th style="text-align:right; padding:8px; border-bottom:1px solid var(--border)">Partial</th>
                      <th style="text-align:right; padding:8px; border-bottom:1px solid var(--border)">No</th>
                      <th style="text-align:right; padding:8px; border-bottom:1px solid var(--border)">N/A</th>
                      <th style="text-align:right; padding:8px; border-bottom:1px solid var(--border)">Score %</th>
                      <th style="text-align:right; padding:8px; border-bottom:1px solid var(--border)">Coverage %</th>
                    </tr>
                  </thead>
                  <tbody id="detailTbody"></tbody>
                </table>
              </div>
              <div style="margin-top:12px">
                <h4 style="margin:0 0 8px">Recent Answers</h4>
                <div id="recentAnswers" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:8px"></div>
              </div>
            </div>
          </div>
        </div>

      </section>
    </main>
  </div>

  <script>
  // Tabs
  (function(){
    const tabs = Array.from(document.querySelectorAll('.tab'));
    const panels = Array.from(document.querySelectorAll('.panel'));
    window.setActivePanel = (selector)=>{
      tabs.forEach(t=> t.classList.toggle('active', t.getAttribute('data-target')===selector));
      panels.forEach(p=> p.classList.toggle('active', '#'+p.id===selector));
    };
    tabs.forEach(t=>{
      t.addEventListener('click', ()=>{
        tabs.forEach(x=> x.classList.toggle('active', x===t));
        const target = t.getAttribute('data-target');
        panels.forEach(p=> p.classList.toggle('active', '#'+p.id===target));
      });
    });
  })();

  // Core state (no history/IndexedDB/PDF)
  const AIRMM_STATE={ meta:{}, functions:{}, answers:{}, activeFunc:null, search:'', selectedFunc:null };
  const $=(s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
  const el=(t,a={},ch=[])=>{ const n=document.createElement(t); for(const [k,v] of Object.entries(a)){
    if(k==='class') n.className=v; else if(k.startsWith('on')&&typeof v==='function') n.addEventListener(k.slice(2),v);
    else if(k==='html') n.innerHTML=v; else n.setAttribute(k,v);} ch.forEach(c=>n.appendChild(typeof c==='string'?document.createTextNode(c):c)); return n;};
  const LEVEL_KEYS=['1','2','3','4','5'];

  function getControlsWrap(){ return $('#controlsWrap')||$('main')||document.body; }
  function getDomainList(){ return $('#domainList')||null; }

  // Sidebar
  function renderFunctionList(){
    const list=getDomainList(); if(!list) return; list.innerHTML='';
    Object.entries(AIRMM_STATE.functions).forEach(([fKey,fObj])=>{
      const total=countFunctionQuestions(fKey), answered=countFunctionAnswered(fKey);
      const node=el('div',{class:'domain'+(AIRMM_STATE.activeFunc===fKey?' active':''),'data-func':fKey},[
        el('div',{},[ el('div',{class:'lab'},[document.createTextNode(fObj.name||fKey)]), el('small',{},[document.createTextNode(`${answered}/${total}`)]) ])
      ]);
      node.addEventListener('click',()=>{ AIRMM_STATE.activeFunc=fKey; AIRMM_STATE.selectedFunc=fKey; renderAll(); setActivePanel('#panel-dashboard'); });
      list.appendChild(node);
    });
  }

  function countFunctionQuestions(fKey){
    const fn=AIRMM_STATE.functions[fKey]||{}; let n=0;
    for(const catKey in (fn.categories||{})){
      const cat=fn.categories[catKey];
      for(const subKey in (cat.subcategories||{})){
        const sub=cat.subcategories[subKey];
        for(const L of LEVEL_KEYS){
          const Lobj=(sub.controls||{})[L]; const list=(Lobj&&Array.isArray(Lobj.controls))?Lobj.controls:[];
          n+=list.length;
        }
      }
    }
    return n;
  }
  function countFunctionAnswered(fKey){
    const pref=fKey+'|'; return Object.keys(AIRMM_STATE.answers).filter(k=>k.startsWith(pref)).length;
  }

  // Questionnaire render (with status badge)
  function renderControls(){
    const wrap=getControlsWrap(); if(!wrap) return; wrap.innerHTML='';
    const fKey=AIRMM_STATE.activeFunc; const fn=AIRMM_STATE.functions[fKey]; if(!fn){ wrap.innerHTML='<p>No data.</p>'; return; }
    const cats=fn.categories||{};
    Object.keys(cats).sort((a,b)=>a.localeCompare(b,undefined,{numeric:true})).forEach(catKey=>{
      const cat=cats[catKey]; const subs=cat.subcategories||{};
      Object.keys(subs).forEach(subKey=>{
        const sub=subs[subKey]; const card=el('div',{class:'control-card', id:`anc-${fKey}-${catKey}-${subKey}`});
        card.appendChild(el('h3',{},[document.createTextNode(sub.name||subKey)]));
        const grid=el('div',{class:'level-grid'});
        LEVEL_KEYS.forEach(L=>{
          const Lobj=(sub.controls||{})[L]; const Lname=(Lobj&&(Lobj.level_name||Lobj.level))||`Level ${L}`;
          const box=el('div',{class:'level'}); box.appendChild(el('h4',{},[document.createTextNode(`${L}. ${Lname}`)]));
          const list=(Lobj&&Array.isArray(Lobj.controls))?Lobj.controls:[];
          if(list.length===0){ box.appendChild(el('div',{class:'desc muted'},['No controls provided for this level.'])); }
          else list.forEach((ctrl,idx)=>{
            const cId=(ctrl.id||'').trim()||`${subKey}-${L}-${idx+1}`; const cDesc=ctrl.description||'';
            const hay=`${cId} ${cDesc}`.toLowerCase(); if(AIRMM_STATE.search && !hay.includes(AIRMM_STATE.search)) return;
            const qKey=`${fKey}|${catKey}|${subKey}|${L}|${idx}`; const val=AIRMM_STATE.answers[qKey]||'';
            const sq=el('div',{class:'sub-question'});
            // Title + status badge
            const titleRow=el('div',{style:'display:flex; align-items:center; justify-content:space-between; gap:8px'});
            titleRow.appendChild(el('div',{class:'sq-title'},[`${cId} — ${cDesc}`]));
            const status=el('span',{class:'sq-status', style:`font-size:12px; font-weight:800; ${val? 'color: var(--ok)':'color: var(--danger)'};`},[ val? 'ANSWERED':'PENDING' ]);
            titleRow.appendChild(status);
            sq.appendChild(titleRow);
            // Answers chips
            const answers=el('div',{class:'answers'});
            ['yes','partial','no','na'].forEach(v=>{
              const chip=el('button',{class:'chip'+(val===v?' active':''),'data-q':qKey,'data-value':v},[v.toUpperCase()]);
              chip.addEventListener('click',()=>{
                AIRMM_STATE.answers[qKey]=v;
                answers.querySelectorAll('.chip').forEach(ch=>ch.classList.toggle('active',ch===chip));
                // flip status -> ANSWERED green
                status.textContent='ANSWERED';
                status.style.color='var(--ok)';
                updateDashboard();
              });
              answers.appendChild(chip);
            });
            sq.appendChild(answers); box.appendChild(sq);
          });
          grid.appendChild(box);
        });
        card.appendChild(grid); wrap.appendChild(card);
      });
    });
  }

  // KPI & dashboard helpers
  function overallTallies(){
    const t={yes:0,partial:0,no:0,na:0,all:0,answered:0};
    const f=AIRMM_STATE.selectedFunc||AIRMM_STATE.activeFunc;
    t.all = f? countFunctionQuestions(f) : Object.keys(AIRMM_STATE.functions).reduce((s,k)=>s+countFunctionQuestions(k),0);
    for(const v of Object.values(AIRMM_STATE.answers)){
      if(v==='yes') t.yes++; else if(v==='partial') t.partial++; else if(v==='no') t.no++; else if(v==='na') t.na++;
      t.answered++;
    }
    return t;
  }

  function renderKPIs(){
    const row=$('#kpiRow'); if(!row) return; const t=overallTallies(); row.innerHTML='';
    const blocks=[ ['Yes',t.yes], ['Partial',t.partial], ['No',t.no], ['N/A',t.na], ['Answered',t.answered], ['Coverage', (t.all?Math.round(100*t.answered/t.all):0)+'%'] ];
    blocks.forEach(([label,val])=>{
      const n=el('div',{class:'kpi'},[ el('h5',{},[label]), el('div',{class:'num'},[String(val)]) ]);
      row.appendChild(n);
    });
  }

  // Distribution stacked bar (non-expanding)
  function renderDistribution(){
    const bar=$('#distBar'); const legend=$('#distLegend'); if(!bar||!legend) return;
    const t=overallTallies(); const total=(t.yes+t.partial+t.no+t.na)||1;
    bar.innerHTML='';
    const mkSeg=(count,label,bg)=>{ const w=Math.round(100*count/total); const seg=el('div',{style:`height:100%; width:${w}%; background:${bg};`}); bar.appendChild(seg); legend.appendChild(el('div',{},[label,': ',String(count),' (',String(w),'%)'])); };
    legend.innerHTML='';
    mkSeg(t.yes,'Yes','rgba(34,197,94,.6)');
    mkSeg(t.partial,'Partial','rgba(245,158,11,.6)');
    mkSeg(t.no,'No','rgba(255,107,107,.6)');
    mkSeg(t.na,'N/A','rgba(153,163,179,.6)');
  }

  // Domain scores chart (inline SVG bars; fixed height/width)
  function renderDomainChart(){
    const box=$('#domainChartBox'); if(!box) return; box.innerHTML='';
    const keys=Object.keys(AIRMM_STATE.functions); if(keys.length===0){ box.textContent='No data'; return; }
    const labels=keys.map(k=>AIRMM_STATE.functions[k]?.name||k);
    const values=keys.map(fKey=>{
      const total=countFunctionQuestions(fKey); let score=0;
      for(const [k,v] of Object.entries(AIRMM_STATE.answers)){
        if(k.startsWith(fKey+'|')){ if(v==='yes') score+=1; else if(v==='partial') score+=0.5; }
      }
      return total? Math.round(100*score/total):0;
    });
    const W=box.clientWidth||600, H=180, pad=28, n=values.length;
    const colW = Math.max(12, (W - pad*2) / (n*1.6));
    const gap = colW*0.6;
    const max=100;

    const svgNS='http://www.w3.org/2000/svg';
    const svg=document.createElementNS(svgNS,'svg');
    svg.setAttribute('width', W); svg.setAttribute('height', H); svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
    // axis
    const axis=document.createElementNS(svgNS,'line');
    axis.setAttribute('x1', pad); axis.setAttribute('y1', H-pad);
    axis.setAttribute('x2', W-pad); axis.setAttribute('y2', H-pad);
    axis.setAttribute('stroke','rgba(255,255,255,.2)'); axis.setAttribute('stroke-width','1');
    svg.appendChild(axis);

    keys.forEach((k, i)=>{
      const v=values[i];
      const x = pad + i*(colW+gap);
      const h = Math.round((H - pad*2) * (v/max));
      const y = (H - pad) - h;

      const rect=document.createElementNS(svgNS,'rect');
      rect.setAttribute('x', x); rect.setAttribute('y', y);
      rect.setAttribute('width', colW); rect.setAttribute('height', h);
      rect.setAttribute('fill','url(#grad)');
      rect.style.cursor='pointer';
      rect.addEventListener('click', ()=>{ AIRMM_STATE.selectedFunc=k; renderDetail(); });
      rect.addEventListener('dblclick', ()=>{ AIRMM_STATE.activeFunc=k; renderControls(); setActivePanel('#panel-questions'); });
      svg.appendChild(rect);

      const label=document.createElementNS(svgNS,'text');
      label.setAttribute('x', x + colW/2); label.setAttribute('y', H-pad+14);
      label.setAttribute('text-anchor','middle'); label.setAttribute('font-size','10'); label.setAttribute('fill','#c8d2ff');
      label.textContent = (labels[i]||k).slice(0,8);
      svg.appendChild(label);

      const valText=document.createElementNS(svgNS,'text');
      valText.setAttribute('x', x + colW/2); valText.setAttribute('y', y-4);
      valText.setAttribute('text-anchor','middle'); valText.setAttribute('font-size','10'); valText.setAttribute('fill','#99a3b3');
      valText.textContent = v + '%';
      svg.appendChild(valText);
    });

    // gradient
    const defs=document.createElementNS(svgNS,'defs');
    const lg=document.createElementNS(svgNS,'linearGradient');
    lg.setAttribute('id','grad'); lg.setAttribute('x1','0'); lg.setAttribute('y1','0'); lg.setAttribute('x2','0'); lg.setAttribute('y2','1');
    const s1=document.createElementNS(svgNS,'stop'); s1.setAttribute('offset','0%'); s1.setAttribute('stop-color','var(--accent)');
    const s2=document.createElementNS(svgNS,'stop'); s2.setAttribute('offset','100%'); s2.setAttribute('stop-color','var(--accent-2)');
    lg.appendChild(s1); lg.appendChild(s2); defs.appendChild(lg); svg.appendChild(defs);

    box.appendChild(svg);
  }

  // Heatmap
  function renderHeatmap(){
    const box=$('#heatmap'); if(!box) return; box.innerHTML='';
    Object.keys(AIRMM_STATE.functions).forEach(fKey=>{
      const fn=AIRMM_STATE.functions[fKey]; const label=fn?.name||fKey; const total=countFunctionQuestions(fKey);
      const tally={yes:0,partial:0,no:0};
      for(const [k,v] of Object.entries(AIRMM_STATE.answers)){
        if(k.startsWith(fKey+'|')){ if(v==='yes')tally.yes++; else if(v==='partial')tally.partial++; else if(v==='no')tally.no++; }
      }
      [['YES',tally.yes],['PARTIAL',tally.partial],['NO',tally.no]].forEach(([L,count])=>{
        const pct=total?Math.round(100*count/total):0;
        const cell=el('div',{class:'hcell',style:'border:1px solid var(--border); border-radius:10px; padding:10px; background:#0e1431; cursor:pointer'},[
          el('div',{style:'font-weight:700; margin-bottom:6px'},[label+' – '+L]),
          el('div',{class:'meter', title:`${pct}%`},[el('i',{style:`width:${pct}%`})]),
          el('div',{class:'muted',style:'margin-top:6px'},[`${count}/${total} (${pct}%)`])
        ]);
        cell.addEventListener('click',()=>{ AIRMM_STATE.selectedFunc=fKey; renderDetail(); });
        cell.addEventListener('dblclick',()=>{ AIRMM_STATE.activeFunc=fKey; renderControls(); setActivePanel('#panel-questions'); });
        box.appendChild(cell);
      });
    });
  }

  // Drilldown
  function computeLevelSummary(fKey){
    const out={1:0,2:0,3:0,4:0,5:0, total:0};
    const fn=AIRMM_STATE.functions[fKey]||{}; const cats=fn.categories||{};
    for(const catKey in cats){
      const subs=cats[catKey].subcategories||{};
      for(const subKey in subs){
        const sub=subs[subKey]; for(const L of LEVEL_KEYS){
          const Lobj=(sub.controls||{})[L]; const list=(Lobj&&Array.isArray(Lobj.controls))?Lobj.controls:[];
          out[L|0]+=list.length; out.total+=list.length;
        }
      }
    }
    return out;
  }

  function computeCategoryRows(fKey){
    const rows=[]; const fn=AIRMM_STATE.functions[fKey]||{}; const cats=fn.categories||{};
    for(const catKey of Object.keys(cats)){
      const cat=cats[catKey]; const subs=cat.subcategories||{}; let yes=0,partial=0,no=0,na=0,total=0,score=0,answered=0;
      for(const subKey of Object.keys(subs)){
        const sub=subs[subKey];
        for(const L of LEVEL_KEYS){
          const Lobj=(sub.controls||{})[L]; const list=(Lobj&&Array.isArray(Lobj.controls))?Lobj.controls:[];
          list.forEach((_,idx)=>{
            const q=`${fKey}|${catKey}|${subKey}|${L}|${idx}`; const v=AIRMM_STATE.answers[q];
            total++;
            if(v==='yes'){ yes++; score+=1; answered++; }
            else if(v==='partial'){ partial++; score+=0.5; answered++; }
            else if(v==='no'){ no++; answered++; }
            else if(v==='na'){ na++; answered++; }
          });
        }
      }
      const scorePct=total?Math.round(100*score/total):0;
      const covPct=total?Math.round(100*answered/total):0;
      rows.push({catKey, catName:cat.name||catKey, yes, partial, no, na, scorePct, covPct});
    }
    return rows.sort((a,b)=>a.catName.localeCompare(b.catName));
  }

  function renderDetail(){
    const fKey=AIRMM_STATE.selectedFunc||Object.keys(AIRMM_STATE.functions)[0]; if(!fKey) return;
    const fn=AIRMM_STATE.functions[fKey]; $('#detailTitle').textContent = (fn?.name||fKey)+' — Details';
    // Level summary
    const sum=computeLevelSummary(fKey); const row=$('#levelSummary'); row.innerHTML='';
    [['Level 1',sum[1]],['Level 2',sum[2]],['Level 3',sum[3]],['Level 4',sum[4]],['Level 5',sum[5]],['Total',sum.total]]
      .forEach(([lab,val])=> row.appendChild(el('div',{class:'kpi'},[el('h5',{},[lab]), el('div',{class:'num'},[String(val)])])));
    // Category table
    const tb=$('#detailTbody'); tb.innerHTML=''; const rows=computeCategoryRows(fKey);
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      const td=(t,align='left')=>{ const n=document.createElement('td'); n.style.padding='8px'; n.style.borderBottom='1px solid var(--border)'; n.style.textAlign=align; n.textContent=t; return n; };
      tr.appendChild(td(r.catName,'left'));
      tr.appendChild(td(String(r.yes),'right'));
      tr.appendChild(td(String(r.partial),'right'));
      tr.appendChild(td(String(r.no),'right'));
      tr.appendChild(td(String(r.na),'right'));
      tr.appendChild(td(r.scorePct+'%','right'));
      tr.appendChild(td(r.covPct+'%','right'));
      tr.style.cursor='pointer';
      tr.title='Click to open first question of this category';
      tr.addEventListener('click', ()=>{
        AIRMM_STATE.activeFunc=fKey; renderControls();
        const fn=AIRMM_STATE.functions[fKey]; const subKey=Object.keys(fn.categories[r.catKey]?.subcategories||{})[0];
        if(subKey){ const anc=document.getElementById(`anc-${fKey}-${r.catKey}-${subKey}`); if(anc){ setActivePanel('#panel-questions'); setTimeout(()=>anc.scrollIntoView({behavior:'smooth', block:'start'}), 50); } }
      });
      tb.appendChild(tr);
    });
    // Recent answers
    const recentBox=$('#recentAnswers'); recentBox.innerHTML='';
    const recent=Object.entries(AIRMM_STATE.answers).filter(([k])=>k.startsWith(fKey+'|')).slice(-12).reverse();
    recent.forEach(([k,v])=>{
      const [_,catKey,subKey,L,idx]=k.split('|');
      const chip=el('button',{class:'btn',title:'Go to question',style:'white-space:nowrap; overflow:hidden; text-overflow:ellipsis'},[
        `${subKey} • L${L} • ${v.toUpperCase()}`
      ]);
      chip.addEventListener('click', ()=>{
        AIRMM_STATE.activeFunc=fKey; renderControls();
        const anc=document.getElementById(`anc-${fKey}-${catKey}-${subKey}`);
        setActivePanel('#panel-questions'); setTimeout(()=>anc?.scrollIntoView({behavior:'smooth', block:'start'}), 50);
      });
      recentBox.appendChild(chip);
    });
  }

  function updateDashboard(){
    renderKPIs(); renderDistribution(); renderDomainChart(); renderHeatmap(); renderFunctionList(); renderDetail();
  }
  function renderAll(){ renderFunctionList(); renderControls(); updateDashboard(); }

  // Search & Save JSON
  document.getElementById('searchInput')?.addEventListener('input', (e)=>{ AIRMM_STATE.search=(e.target.value||'').toLowerCase(); renderControls(); });
  document.getElementById('btnExportJSON')?.addEventListener('click', ()=>{
    const payload={ saved_at:new Date().toISOString(), meta:AIRMM_STATE.meta, answers:AIRMM_STATE.answers };
    const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download=`AIRMM_Assessment_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  });

  // Boot
  async function boot(){
    try{
      const res=await fetch('airmm_controls.json',{cache:'no-store'}); if(!res.ok) throw new Error('Cannot load airmm_controls.json');
      const data=await res.json();
      if(data.functions){
        AIRMM_STATE.meta.version=data.metadata?.version||data.version||'v0.2';
        AIRMM_STATE.meta.generated_at=data.metadata?.generated_at||data.generated_at||'';
        AIRMM_STATE.functions=data.functions||{};
      }else if(data.controls){
        AIRMM_STATE.meta.version=data.version||'v0.2';
        AIRMM_STATE.meta.generated_at=data.generated_at||'';
        AIRMM_STATE.functions=Object.fromEntries(Object.keys(data.controls).map(k=>[
          k,{ name:k, categories:{ general:{ name:'General', subcategories:Object.fromEntries(
            Object.entries(data.controls[k]||{}).map(([cid,obj])=>[cid,{ name: obj.title||cid, controls: obj.levels||{} }])
          ) } } }
        ]));
      }else{
        AIRMM_STATE.functions={};
      }
      AIRMM_STATE.activeFunc=Object.keys(AIRMM_STATE.functions)[0]||null;
      AIRMM_STATE.selectedFunc=AIRMM_STATE.activeFunc;
      renderAll();
    }catch(err){
      console.error(err);
      const wrap=getControlsWrap();
      if(wrap){ wrap.innerHTML=`<div class="card" style="margin:16px"><h3>Failed to load controls</h3><p class="muted">${(err&&err.message)||err}</p><p>Ensure <code>airmm_controls.json</code> is placed next to this HTML file and is valid JSON.</p></div>`; }
    }
  }
  document.addEventListener('DOMContentLoaded', boot);

  // Detail buttons
  document.getElementById('btnDetailQuestions')?.addEventListener('click', ()=>{
    if(AIRMM_STATE.selectedFunc){ AIRMM_STATE.activeFunc=AIRMM_STATE.selectedFunc; renderControls(); setActivePanel('#panel-questions'); }
  });
  document.getElementById('btnDetailReset')?.addEventListener('click', ()=>{
    AIRMM_STATE.selectedFunc=AIRMM_STATE.activeFunc; updateDashboard();
  });
  </script>
</body>
</html>
